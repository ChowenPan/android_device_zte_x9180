From e5f0b8932b14b0bfb4125e8ae08444e5fdfbefae Mon Sep 17 00:00:00 2001
From: MarcKe <herderkewitz@googlemail.com>
Date: Wed, 18 Feb 2015 13:47:38 +0100
Subject: [PATCH] Telephony: implement noise suppression for phone calls (3/3)

---
 .../android/server/telecom/CallAudioManager.java   | 54 ++++++++++++++++++++++
 1 file changed, 54 insertions(+)

diff --git a/src/com/android/server/telecom/CallAudioManager.java b/src/com/android/server/telecom/CallAudioManager.java
index 77cb7c4..652acc6 100644
--- a/src/com/android/server/telecom/CallAudioManager.java
+++ b/src/com/android/server/telecom/CallAudioManager.java
@@ -17,6 +17,8 @@
 package com.android.server.telecom;
 
 import android.content.Context;
+import android.content.pm.PackageManager.NameNotFoundException;
+import android.content.res.Resources;
 import android.media.AudioManager;
 import android.telecom.AudioState;
 import android.telecom.CallState;
@@ -31,6 +33,8 @@
 final class CallAudioManager extends CallsManagerListenerBase
         implements WiredHeadsetManager.Listener {
     private static final int STREAM_NONE = -1;
+    private static final boolean DBG = false;
+
 
     private final StatusBarNotifier mStatusBarNotifier;
     private final AudioManager mAudioManager;
@@ -68,6 +72,8 @@ AudioState getAudioState() {
     public void onCallAdded(Call call) {
         onCallUpdated(call);
 
+        turnOnNoiseSuppression(mContext, true);
+
         if (hasFocus() && getForegroundCall() == call) {
             if (!call.isIncoming()) {
                 // Unmute new outgoing call.
@@ -79,6 +85,8 @@ public void onCallAdded(Call call) {
     @Override
     public void onCallRemoved(Call call) {
         // If we didn't already have focus, there's nothing to do.
+        turnOnNoiseSuppression(mContext, false);
+
         if (hasFocus()) {
             if (CallsManager.getInstance().getCalls().isEmpty()) {
                 Log.v(this, "all calls removed, reseting system audio to default state");
@@ -98,6 +106,8 @@ public void onCallStateChanged(Call call, int oldState, int newState) {
     public void onIncomingCallAnswered(Call call) {
         int route = mAudioState.route;
 
+        turnOnNoiseSuppression(mContext, true);
+
         // BT stack will connect audio upon receiving active call state.
         // We unmute the audio for the new incoming call.
 
@@ -522,4 +532,48 @@ private boolean hasRingingForegroundCall() {
     private boolean hasFocus() {
         return mAudioFocusStreamType != STREAM_NONE;
     }
+
+    static void turnOnNoiseSuppression(Context context, boolean flag) {
+        if (DBG) Log.i("NoiseSuppression", "turnOnNoiseSuppression: %b", flag);
+        Resources res;
+        // get resource from services telephony
+        try {
+            res = context.getPackageManager().getResourcesForApplication("com.android.phone");
+        } catch (NameNotFoundException e) {
+            e.printStackTrace();
+            return;
+        }
+        int resourceId = res.getIdentifier("com.android.phone:bool/has_in_call_noise_suppression", null, null);
+        if (!res.getBoolean(resourceId)) {
+            return;
+        }
+        AudioManager audioManager = (AudioManager) context.getSystemService(Context.AUDIO_SERVICE);
+
+        int nsp = android.provider.Settings.System.getInt(context.getContentResolver(),
+                android.provider.Settings.System.NOISE_SUPPRESSION, 1);
+
+        resourceId = res.getIdentifier("com.android.phone:string/in_call_noise_suppression_audioparameter", null, null);
+        String aParam = res.getString(resourceId);
+        String[] aPValues = aParam.split("=");
+
+        if (aPValues[0].length() == 0) {
+            aPValues[0] = "noise_suppression";
+        }
+
+        if (aPValues[1].length() == 0) {
+            aPValues[1] = "on";
+        }
+
+        if (aPValues[2].length() == 0) {
+            aPValues[2] = "off";
+        }
+
+        if (nsp == 1 && flag) {
+            if (DBG) Log.i("NoiseSuppression", "turnOnNoiseSuppression: %s=%s" + aPValues[0], aPValues[1]);
+            audioManager.setParameters(aPValues[0] + "=" + aPValues[1]);
+        } else {
+            if (DBG) Log.i("NoiseSuppression", "turnOnNoiseSuppression: %s=%s" + aPValues[0], aPValues[2]);
+            audioManager.setParameters(aPValues[0] + "=" + aPValues[2]);
+        }
+    }
 }
